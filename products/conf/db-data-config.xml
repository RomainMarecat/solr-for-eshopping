<dataConfig>
  <dataSource name="db" type="JdbcDataSource" driver="com.mysql.jdbc.Driver" url="jdbc:mysql://localhost/romainmarecat_symfony" user="romainmarecat" password="romainmarecat" readonly="true"/>

  <document name="products">
    <entity dataSource="db" pk="p.id" name="product" query="
        SELECT            
            p.id as id, p.name, p.keywords, br.name AS brand, v.ean, v.price, 
            routing_parser(p.slug) AS routing, v.sku AS reference,
            util_loc.city AS town,
            city_expanded_parser(util_loc.city, util_loc.postcode) AS city_expanded,
            coordinate_parser(util_loc.latitude, util_loc.longitude) AS coordinate,
            cat.title AS category,
            p.description AS content,
            image_url_parser(p.gallery) AS image,
            p.is_visible, p.is_saleable as saleable, 
            stock_parser(v.stock), 
            v.price,
            p.available_for_mail_order,
            p.available_in_my_shop,
            ss.idShop AS shops,
            v.special_price AS special_price, v.id AS special_price_variant_id, 
            discount_rate_parser(special_price, v.price) as discount_rate,
            v.special_price_from_date,
            v.special_price_to_date,
            cat.id AS product_category_id
        FROM 
            product AS p 
        INNER JOIN 
            (
            SELECT  
                v1.*, MIN(v1.price) minprice
            FROM    
                variant AS v1
            GROUP BY 
                v1.product_id
        ) AS v
            ON p.id = v.product_id AND v.price = minprice
        LEFT JOIN 
            products_categories AS pc
            ON p.id = pc.product_id
        LEFT JOIN 
            category AS cat
            ON pc.category_id = cat.id
        LEFT JOIN     
            products_shops AS ps
            ON p.id = ps.product_id
        LEFT JOIN 
            shop_shop AS ss
            ON ps.shop_id = ss.idShop
        LEFT JOIN 
            util_location AS util_loc
            ON ss.idLocation = util_loc.idLocation
        LEFT JOIN 
            brand AS br
            ON p.brand_id = br.id
        ">
        <!--  
            WHERE p.id = IF('${dataimporter.request.id}', '${dataimporter.request.id}', '%')
            AND (p.updated_at + INTERVAL 2 MINUTE) >= IF('${dataimporter.request.updated_at}', '${dataimporter.request.updated_at}', 0) -->
        <field column="id" name="id" />
        <field column="name" name="name" />
        <field column="keywords" name="keywords "/>
        <field column="brand" name="brand" />
        <field column="ean" name="ean" />
        <field column="price" name="price" />
        <field column="routing" name="routing"  />        
        <field column="sku" name="reference"/>
        <field column="city" name="town"/>
        <field column="city_expanded" name="city_expanded"/>
        <field column="coordinate" name="coordinate"/>
        <field column="category" name="category"/>   
        <field column="content" name="content" />
        <field column="image" name="image" />
        <field column="is_visible" name="status" />
        <field column="saleable" name="saleable"/>
        <field column="stock" name="stock" />
        <field column="shops" name="shops" />
        <field column="special_price" name="special_price" />
        <field column="special_price_variant_id" name="special_price_variant_id" />
        <field column="special_price_from_date" name="special_price_from_date" />
        <field column="special_price_to_date" name="special_price_to_date" />
        <field column="discount_rate" name="discount_rate" />
        <entity name="availability" dataSource="db" pk="id" query="
                SELECT available_for_mail_order_parser(available_for_mail_order) as availability 
                FROM product 
                WHERE id ='${product.id}'  
                UNION ALL 
                SELECT available_in_my_shop_parser(available_in_my_shop) as availability 
                FROM product 
                WHERE id ='${product.id}'">
            <field column="availability" name="availability" />
        </entity>       
        <entity name="nav_categories" dataSource="db" pk="id" query="
                    SELECT solr.navigation_path, solr.navigation_ids, solr.navigation, solr.category_ids, solr.category_path
                    FROM solr_dataimport AS solr 
                    WHERE solr.category_id = IF('${product.product_category_id}', '${product.product_category_id}', NULL)">
            <field column="category_ids" name="category_ids"/>
            <field column="category_path" name="category_path"/>
            <field column="navigation" name="navigation"/>
            <field column="navigation_ids" name="navigation_ids" />
            <field column="navigation_path" name="navigation_path" />
        </entity> 
    </entity>
  </document>
</dataConfig>